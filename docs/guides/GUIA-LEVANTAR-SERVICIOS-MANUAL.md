# üöÄ Gu√≠a Completa: Levantar y Probar Todos los Servicios ARKA

## üìã √çndice
1. [Prerrequisitos](#prerrequisitos)
2. [Orden de Inicio de Servicios](#orden-de-inicio-de-servicios)
3. [Configuraci√≥n de Base de Datos](#configuraci√≥n-de-base-de-datos)
4. [Servicios Principales](#servicios-principales)
5. [Servicios de Negocio](#servicios-de-negocio)
6. [Servicios Avanzados](#servicios-avanzados)
7. [Verificaci√≥n de Servicios](#verificaci√≥n-de-servicios)
8. [Pruebas Funcionales](#pruebas-funcionales)
9. [Soluci√≥n de Problemas](#soluci√≥n-de-problemas)

---

## üîß Prerrequisitos

### üì¶ Software Requerido
```powershell
# Verificar Java 21
java -version

# Verificar Gradle
gradle -version

# Verificar Git
git --version

# Verificar PowerShell (versi√≥n 5.1+)
$PSVersionTable.PSVersion
```

### üóÑÔ∏è Base de Datos
```powershell
# MongoDB (para Reportes y Saga Tracker)
# Descargar desde: https://www.mongodb.com/try/download/community
# O usar Docker:
docker run -d --name mongodb -p 27017:27017 mongo:7

# Verificar conexi√≥n MongoDB
mongo --eval "db.adminCommand('ismaster')"
```

### ‚òÅÔ∏è Servicios AWS (Opcional para desarrollo)
```powershell
# Instalar LocalStack para simulaci√≥n AWS local
pip install localstack
localstack start

# O configurar AWS CLI con credenciales reales
aws configure
```

---

## üéØ Orden de Inicio de Servicios

### üìä **Secuencia Recomendada:**
1. **Config Server** (Puerto 8888)
2. **Eureka Server** (Puerto 8761)
3. **API Gateway** (Puerto 8080)
4. **Servicios de Negocio** (Puertos 8081-8088)
5. **Servicios Avanzados** (Puertos 8089+)

---

## üèóÔ∏è Configuraci√≥n de Base de Datos

### üçÉ MongoDB Setup
```powershell
# 1. Crear directorios de datos
mkdir C:\data\db -Force

# 2. Iniciar MongoDB (Windows)
mongod --dbpath C:\data\db --port 27017

# 3. Verificar conexi√≥n
mongo mongodb://localhost:27017

# 4. Crear bases de datos (se crean autom√°ticamente en primer uso)
# - reportes_db (para arca-reportes)
# - saga_tracking (para saga-state-tracker)
```

### üóÑÔ∏è H2 Database (Para desarrollo)
```powershell
# Los servicios usan H2 en memoria por defecto
# No requiere configuraci√≥n adicional para testing
```

---

## üèóÔ∏è Servicios Principales

### 1. **Config Server** üìã
```powershell
# Terminal 1 - Config Server
cd C:\Users\valen\arkavalenzuela-1
./gradlew :config-server:bootRun

# Verificar en navegador: http://localhost:8888/actuator/health
# Configuraciones disponibles: http://localhost:8888/application/default
```

**‚è≥ Esperar**: Servicio completamente iniciado antes de continuar.

### 2. **Eureka Server** üåê
```powershell
# Terminal 2 - Eureka Server
cd C:\Users\valen\arkavalenzuela-1
./gradlew :eureka-server:bootRun

# Verificar en navegador: http://localhost:8761
# Panel de Control Eureka: http://localhost:8761/eureka/web
```

**‚è≥ Esperar**: Ver "Eureka Server started" en los logs.

### 3. **API Gateway** üö™
```powershell
# Terminal 3 - API Gateway
cd C:\Users\valen\arkavalenzuela-1
./gradlew :api-gateway:bootRun

# Verificar: http://localhost:8080/actuator/health
# Rutas disponibles: http://localhost:8080/actuator/gateway/routes
```

---

## üè¢ Servicios de Negocio

### 4. **Hello World Service** üëã
```powershell
# Terminal 4 - Hello World Service
cd C:\Users\valen\arkavalenzuela-1
./gradlew :hello-world-service:bootRun

# Puerto: 8081
# Salud: http://localhost:8081/actuator/health
# Prueba: http://localhost:8081/hello
```

### 5. **Arca Cotizador** üí∞
```powershell
# Terminal 5 - Arca Cotizador
cd C:\Users\valen\arkavalenzuela-1
./gradlew :arca-cotizador:bootRun

# Puerto: 8082
# Salud: http://localhost:8082/actuator/health
# API: http://localhost:8082/api/cotizaciones
```

### 6. **Arca Gestor Solicitudes** üìù
```powershell
# Terminal 6 - Arca Gestor Solicitudes
cd C:\Users\valen\arkavalenzuela-1
./gradlew :arca-gestor-solicitudes:bootRun

# Puerto: 8083
# Salud: http://localhost:8083/actuator/health
# API: http://localhost:8083/api/solicitudes
```

---

## üîß Servicios Avanzados

### 7. **Arca Reportes** üìä
```powershell
# Terminal 7 - Arca Reportes
cd C:\Users\valen\arkavalenzuela-1

# Verificar que MongoDB est√© funcionando
mongo --eval "db.runCommand({ping: 1})"

# Iniciar servicio
./gradlew :arca-reportes:bootRun

# Puerto: 8088
# Salud: http://localhost:8088/actuator/health
# API: http://localhost:8088/api/reportes
```

### 8. **Saga State Tracker** üîÑ
```powershell
# Terminal 8 - Saga State Tracker
cd C:\Users\valen\arkavalenzuela-1

# Verificar MongoDB
mongo saga_tracking --eval "db.stats()"

# Iniciar servicio
./gradlew :saga-state-tracker:bootRun

# Puerto: 8089
# Salud: http://localhost:8089/saga-tracker/actuator/health
# Panel de Control: http://localhost:8089/saga-tracker/api/saga/dashboard
```

---

## ‚úÖ Verificaci√≥n de Servicios

### üè• Verificaciones de Salud Autom√°ticas
```powershell
# Script para verificar todos los servicios
# Ejecutar desde la ra√≠z del proyecto

# Verificar servicios principales
$servicios = @(
    @{nombre="Config Server"; url="http://localhost:8888/actuator/health"},
    @{nombre="Eureka Server"; url="http://localhost:8761/actuator/health"},
    @{nombre="API Gateway"; url="http://localhost:8080/actuator/health"},
    @{nombre="Hello World"; url="http://localhost:8081/actuator/health"},
    @{nombre="Arca Cotizador"; url="http://localhost:8082/actuator/health"},
    @{nombre="Arca Gestor"; url="http://localhost:8083/actuator/health"},
    @{nombre="Arca Reportes"; url="http://localhost:8088/actuator/health"},
    @{nombre="Saga Tracker"; url="http://localhost:8089/saga-tracker/actuator/health"}
)

foreach ($servicio in $servicios) {
    try {
        $respuesta = Invoke-RestMethod -Uri $servicio.url -TimeoutSec 5
        if ($respuesta.status -eq "UP") {
            Write-Host "‚úÖ $($servicio.nombre) - SALUDABLE" -ForegroundColor Green
        } else {
            Write-Host "‚ö†Ô∏è $($servicio.nombre) - $($respuesta.status)" -ForegroundColor Yellow
        }
    } catch {
        Write-Host "‚ùå $($servicio.nombre) - INACTIVO" -ForegroundColor Red
    }
}
```

### üåê Verificaci√≥n en Eureka
```powershell
# Abrir navegador en Panel de Control Eureka
Start-Process "http://localhost:8761"

# Verificar que todos los servicios aparezcan registrados:
# - HELLO-WORLD-SERVICE
# - ARCA-COTIZADOR
# - ARCA-GESTOR-SOLICITUDES
# - ARCA-REPORTES
# - SAGA-STATE-TRACKER
```

---

## üß™ Pruebas Funcionales

### üìã **Prueba 1: Hello World Service**
```powershell
# Prueba b√°sica
curl http://localhost:8081/hello

# A trav√©s del API Gateway
curl http://localhost:8080/hello-world/hello

# Respuesta esperada: "¬°Hola desde ARKA Hello World Service!"
```

### üí∞ **Prueba 2: Arca Cotizador**
```powershell
# Crear cotizaci√≥n
$cotizacion = @{
    clienteId = "CLI001"
    productos = @(
        @{ id = "PROD001"; cantidad = 2; precio = 100.0 },
        @{ id = "PROD002"; cantidad = 1; precio = 50.0 }
    )
} | ConvertTo-Json -Depth 3

# Enviar cotizaci√≥n
$respuesta = Invoke-RestMethod -Uri "http://localhost:8082/api/cotizaciones" -Method Post -Body $cotizacion -ContentType "application/json"

Write-Host "Cotizaci√≥n creada: $($respuesta.id)"
Write-Host "Total: $($respuesta.total)"

# Obtener cotizaci√≥n
curl "http://localhost:8082/api/cotizaciones/$($respuesta.id)"
```

### üìù **Prueba 3: Arca Gestor Solicitudes**
```powershell
# Crear solicitud
$solicitud = @{
    clienteId = "CLI001"
    tipo = "NUEVA_POLIZA"
    descripcion = "Solicitud de nueva p√≥liza de seguro"
    prioridad = "ALTA"
} | ConvertTo-Json

$respuesta = Invoke-RestMethod -Uri "http://localhost:8083/api/solicitudes" -Method Post -Body $solicitud -ContentType "application/json"

Write-Host "Solicitud creada: $($respuesta.id)"

# Listar solicitudes
curl "http://localhost:8083/api/solicitudes"
```

### üìä **Prueba 4: Arca Reportes**
```powershell
# Verificar servicio
curl "http://localhost:8088/api/reportes/health"

# Generar reporte de carritos abandonados
curl "http://localhost:8088/api/reportes/carritos-abandonados?formato=JSON&diasAtras=7"

# Generar reporte PDF (descargar archivo)
curl "http://localhost:8088/api/reportes/productos-abastecer?formato=PDF" -OutFile "reporte-productos.pdf"

# Verificar reportes programados
curl "http://localhost:8088/api/reportes/programados"
```

### üîÑ **Prueba 5: Saga State Tracker**
```powershell
# Crear estado de saga de prueba
$actualizacionSaga = @{
    ordenId = "TEST-001"
    sagaId = "SAGA-TEST-001"
    tipoEvento = "INICIO_SAGA"
    timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ss")
} | ConvertTo-Json

$respuesta = Invoke-RestMethod -Uri "http://localhost:8089/saga-tracker/api/saga/actualizar-estado" -Method Post -Body $actualizacionSaga -ContentType "application/json"

# Consultar estado
curl "http://localhost:8089/saga-tracker/api/saga/estado/TEST-001"

# Ver panel de control
curl "http://localhost:8089/saga-tracker/api/saga/dashboard?horas=24"
```

---

## üß™ Scripts de Prueba Automatizados

### üìã **Ejecutar Todas las Pruebas**
```powershell
# Prueba completa de todos los servicios
.\test-all-services.ps1

# Prueba espec√≠fica de reportes
.\test-reportes-simple.ps1

# Prueba espec√≠fica de saga tracker
.\test-actividad8-saga-tracker.ps1

# Prueba de integraci√≥n completa
.\test-saga.bat
```

### üìä **Monitoreo Continuo**
```powershell
# Script para monitoreo continuo (ejecutar en PowerShell)
while ($true) {
    Clear-Host
    Write-Host "üîÑ ESTADO SERVICIOS ARKA - $(Get-Date)" -ForegroundColor Cyan
    Write-Host "=" * 50
    
    $servicios = @(
        @{nombre="Config Server"; puerto="8888"},
        @{nombre="Eureka Server"; puerto="8761"},
        @{nombre="API Gateway"; puerto="8080"},
        @{nombre="Hello World"; puerto="8081"},
        @{nombre="Cotizador"; puerto="8082"},
        @{nombre="Gestor Sol."; puerto="8083"},
        @{nombre="Reportes"; puerto="8088"},
        @{nombre="Saga Tracker"; puerto="8089"}
    )
    
    foreach ($servicio in $servicios) {
        $url = "http://localhost:$($servicio.puerto)/actuator/health"
        try {
            $respuesta = Invoke-RestMethod -Uri $url -TimeoutSec 2
            $estado = if ($respuesta.status -eq "UP") { "üü¢ ACTIVO" } else { "üü° $($respuesta.status)" }
        } catch {
            $estado = "üî¥ INACTIVO"
        }
        Write-Host "$($servicio.nombre.PadRight(15)) [$($servicio.puerto)] - $estado"
    }
    
    Start-Sleep -Seconds 10
}
```

---

## üõ†Ô∏è Soluci√≥n de Problemas

### ‚ùå **Problemas Comunes**

#### **Puerto ya en uso**
```powershell
# Verificar qu√© proceso usa el puerto
netstat -ano | findstr :8080

# Terminar proceso por PID
taskkill /PID <PID> /F

# O cambiar puerto en application.yml
server:
  port: 8081  # Cambiar a puerto disponible
```

#### **MongoDB no conecta**
```powershell
# Verificar si MongoDB est√° funcionando
tasklist | findstr mongod

# Iniciar MongoDB manualmente
mongod --dbpath C:\data\db

# Verificar conectividad
mongo --eval "db.adminCommand('ping')"
```

#### **Servicios no se registran en Eureka**
```powershell
# Verificar que Config Server est√© funcionando primero
curl http://localhost:8888/actuator/health

# Verificar configuraci√≥n en config-repository/application.yml
# Reiniciar servicio despu√©s de Eureka
```

#### **Gradle build falla**
```powershell
# Limpiar y reconstruir
./gradlew clean build

# Verificar dependencias
./gradlew dependencies

# Construir espec√≠fico
./gradlew :arca-reportes:build --debug
```

#### **OutOfMemory en compilaci√≥n**
```powershell
# Aumentar memoria de Gradle
$env:GRADLE_OPTS="-Xmx2048m -XX:MaxMetaspaceSize=512m"

# O editar gradle.properties
org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m
```

### üîç **Logs y Depuraci√≥n**

#### **Ver logs en tiempo real**
```powershell
# Logs con m√°s detalle
./gradlew :arca-reportes:bootRun --debug

# O configurar logging en application.yml
logging:
  level:
    com.arka: DEBUG
    org.springframework: INFO
```

#### **Verificar configuraci√≥n**
```powershell
# Ver configuraci√≥n actual de un servicio
curl http://localhost:8088/actuator/configprops

# Ver variables de entorno
curl http://localhost:8088/actuator/env
```

---

## üöÄ **Secuencia Completa de Inicio**

### **Script Principal** (Ejecutar paso a paso)
```powershell
# 1. PREPARACI√ìN
Write-Host "üîß Preparando entorno..."
./gradlew clean build

# 2. BASES DE DATOS
Write-Host "üóÑÔ∏è Iniciando MongoDB..."
Start-Process -FilePath "mongod" -ArgumentList "--dbpath C:\data\db"
Start-Sleep -Seconds 5

# 3. SERVICIOS PRINCIPALES (en terminales separadas)
Write-Host "üìã Iniciando Config Server..."
Start-Process powershell -ArgumentList "-Command", "cd '$PWD'; ./gradlew :config-server:bootRun"
Start-Sleep -Seconds 30

Write-Host "üåê Iniciando Eureka Server..."
Start-Process powershell -ArgumentList "-Command", "cd '$PWD'; ./gradlew :eureka-server:bootRun"
Start-Sleep -Seconds 30

Write-Host "üö™ Iniciando API Gateway..."
Start-Process powershell -ArgumentList "-Command", "cd '$PWD'; ./gradlew :api-gateway:bootRun"
Start-Sleep -Seconds 20

# 4. SERVICIOS DE NEGOCIO
Write-Host "üëã Iniciando Hello World Service..."
Start-Process powershell -ArgumentList "-Command", "cd '$PWD'; ./gradlew :hello-world-service:bootRun"

Write-Host "üí∞ Iniciando Arca Cotizador..."
Start-Process powershell -ArgumentList "-Command", "cd '$PWD'; ./gradlew :arca-cotizador:bootRun"

Write-Host "üìù Iniciando Arca Gestor Solicitudes..."
Start-Process powershell -ArgumentList "-Command", "cd '$PWD'; ./gradlew :arca-gestor-solicitudes:bootRun"

Start-Sleep -Seconds 45

# 5. SERVICIOS AVANZADOS
Write-Host "üìä Iniciando Arca Reportes..."
Start-Process powershell -ArgumentList "-Command", "cd '$PWD'; ./gradlew :arca-reportes:bootRun"

Write-Host "üîÑ Iniciando Saga State Tracker..."
Start-Process powershell -ArgumentList "-Command", "cd '$PWD'; ./gradlew :saga-state-tracker:bootRun"

# 6. VERIFICACI√ìN
Start-Sleep -Seconds 60
Write-Host "‚úÖ Verificando servicios..."
.\test-all-services.ps1

Write-Host "üöÄ ¬°Todos los servicios iniciados! Accede a http://localhost:8761 para ver el panel de control Eureka."
```

---

## üìã **URLs de Referencia R√°pida**

| Servicio | Puerto | Verificaci√≥n de Salud | Panel de Control/API |
|----------|--------|----------------------|----------------------|
| **Config Server** | 8888 | [Salud](http://localhost:8888/actuator/health) | [Configuraciones](http://localhost:8888/application/default) |
| **Eureka Server** | 8761 | [Salud](http://localhost:8761/actuator/health) | [Panel de Control](http://localhost:8761) |
| **API Gateway** | 8080 | [Salud](http://localhost:8080/actuator/health) | [Rutas](http://localhost:8080/actuator/gateway/routes) |
| **Hello World** | 8081 | [Salud](http://localhost:8081/actuator/health) | [API](http://localhost:8081/hello) |
| **Arca Cotizador** | 8082 | [Salud](http://localhost:8082/actuator/health) | [API](http://localhost:8082/api/cotizaciones) |
| **Arca Gestor** | 8083 | [Salud](http://localhost:8083/actuator/health) | [API](http://localhost:8083/api/solicitudes) |
| **Arca Reportes** | 8088 | [Salud](http://localhost:8088/actuator/health) | [API](http://localhost:8088/api/reportes) |
| **Saga Tracker** | 8089 | [Salud](http://localhost:8089/saga-tracker/actuator/health) | [Panel de Control](http://localhost:8089/saga-tracker/api/saga/dashboard) |

---

## üéØ **Siguientes Pasos**

Una vez que todos los servicios est√©n funcionando:

1. **üåê Explorar Panel de Control Eureka**: http://localhost:8761
2. **üìä Ver Panel de Control de Saga**: http://localhost:8089/saga-tracker/api/saga/dashboard
3. **üß™ Ejecutar Pruebas**: `.\test-all-services.ps1`
4. **üìà Generar Reportes**: Usar endpoints de arca-reportes
5. **üîÑ Probar Patr√≥n Saga**: Usar APIs de saga-state-tracker

¬°El ecosistema ARKA est√° listo para desarrollo y pruebas! üöÄ
