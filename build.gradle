plugins {
	id 'java'
	id 'war'
	id 'org.springframework.boot' version '3.2.3'
	id 'io.spring.dependency-management' version '1.1.4'
	id 'jacoco'
	id 'org.sonarqube' version '4.4.1.3373'
}

// ConfiguraciÃ³n comÃºn para todos los mÃ³dulos
allprojects {
	group = 'com.arka'
	version = '0.0.1-SNAPSHOT'
	
	repositories {
		mavenCentral()
	}
}

// ConfiguraciÃ³n para submÃ³dulos
subprojects {
	apply plugin: 'java'
	apply plugin: 'org.springframework.boot'
	apply plugin: 'io.spring.dependency-management'
	apply plugin: 'jacoco'
	
	java {
		toolchain {
			languageVersion = JavaLanguageVersion.of(21)
		}
	}
	
	dependencyManagement {
		imports {
			mavenBom 'org.springframework.cloud:spring-cloud-dependencies:2023.0.1'
		}
	}
	
	dependencies {
		implementation 'org.springframework.boot:spring-boot-starter'
		implementation 'org.springframework.boot:spring-boot-starter-webflux'
		implementation 'org.springframework.cloud:spring-cloud-starter-config'
		implementation 'org.springframework.cloud:spring-cloud-starter-bootstrap'
		
		// Spring Security dependencies para todos los mÃ³dulos
		implementation 'org.springframework.boot:spring-boot-starter-security'
		implementation 'org.springframework.security:spring-security-oauth2-resource-server'
		implementation 'org.springframework.security:spring-security-oauth2-jose'
		implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
		implementation 'io.jsonwebtoken:jjwt-impl:0.12.3'
		implementation 'io.jsonwebtoken:jjwt-jackson:0.12.3'
		implementation 'org.springframework.security:spring-security-crypto'
		implementation 'software.amazon.awssdk:regions:2.33.0'

		implementation 'software.amazon.awssdk:s3:2.25.18'
		implementation 'software.amazon.awssdk:core:2.25.18'
		implementation 'software.amazon.awssdk:regions:2.25.18'
		implementation 'org.springframework.boot:spring-boot-starter-web'
		annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
				
		testImplementation 'org.springframework.boot:spring-boot-starter-test'
		testImplementation 'org.springframework.security:spring-security-test'
		testImplementation 'io.projectreactor:reactor-test'
		testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
	}
	
	tasks.named('test') {
		useJUnitPlatform()
		finalizedBy jacocoTestReport
	}
	
	// ğŸ“Š ConfiguraciÃ³n JaCoCo para submÃ³dulos
	jacoco {
		toolVersion = "0.8.11"
	}
	
	// ğŸš€ ConfiguraciÃ³n bootRun con opciones de desarrollo
	bootRun {
		// Habilitar live reload automÃ¡tico
		if (project.hasProperty('dev')) {
			systemProperty 'spring.profiles.active', 'dev'
			systemProperty 'spring.devtools.restart.enabled', 'true'
			systemProperty 'spring.devtools.livereload.enabled', 'true'
		}
		
		// Configurar memoria JVM para desarrollo
		jvmArgs = [
			'-Xmx1024m',
			'-Xms512m',
			'-XX:+UseG1GC',
			'-XX:+UseStringDeduplication'
		]
		
		// Permitir debug remoto
		if (project.hasProperty('debug')) {
			jvmArgs += [
				'-Xdebug',
				'-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005'
			]
		}
	}
	
	jacocoTestReport {
		dependsOn test
		reports {
			xml.required = true
			html.required = true
			csv.required = false
		}
		
		// Exclusiones especÃ­ficas para cada submÃ³dulo
		afterEvaluate {
			classDirectories.setFrom(files(classDirectories.files.collect {
				fileTree(dir: it, exclude: [
					'**/config/**',
					'**/dto/**',
					'**/*Application*',
					'**/Vulnerable*',
					'**/CodeSmells*'
				])
			}))
		}
	}
	
	jacocoTestCoverageVerification {
		violationRules {
			rule {
				limit {
					minimum = 0.60 // 60% mÃ­nimo de cobertura
				}
			}
		}
	}
}

// ===============================================
// ğŸš€ TAREAS GRADLE PARA BOOTRUN OPTIMIZADO
// ===============================================

// Tarea para iniciar todos los servicios en orden
task startAllServices {
	description = 'Inicia todos los microservicios en el orden correcto'
	group = 'Arka Deployment'
	
	doLast {
		println "ğŸš€ Iniciando todos los microservicios..."
		println "ğŸ“‹ Orden de inicio: Config Server -> Eureka -> Gateway -> Servicios"
		println "ğŸ’¡ Tip: Usa Ctrl+C para detener cada servicio individualmente"
		
		// Ejecutar script PowerShell
		if (System.getProperty('os.name').toLowerCase().contains('windows')) {
			exec {
				commandLine 'powershell', '-ExecutionPolicy', 'Bypass', '-File', './start-all-services.ps1'
			}
		} else {
			exec {
				commandLine 'bash', './start-all-services.sh'
			}
		}
	}
}

// Tarea para verificar health de servicios
task checkHealth {
	description = 'Verifica el health de todos los microservicios'
	group = 'Arka Deployment'
	
	doLast {
		println "ğŸ” Verificando health de todos los servicios..."
		
		if (System.getProperty('os.name').toLowerCase().contains('windows')) {
			exec {
				commandLine 'powershell', '-ExecutionPolicy', 'Bypass', '-File', './check-services-health.ps1'
			}
		} else {
			println "â— Health check automÃ¡tico disponible solo en Windows. Use curl manualmente."
		}
	}
}

// Tarea para detener todos los servicios
task stopAllServices {
	description = 'Detiene todos los microservicios'
	group = 'Arka Deployment'
	
	doLast {
		println "ğŸ›‘ Deteniendo todos los microservicios..."
		
		if (System.getProperty('os.name').toLowerCase().contains('windows')) {
			exec {
				commandLine 'powershell', '-ExecutionPolicy', 'Bypass', '-File', './stop-all-services.ps1'
			}
		} else {
			exec {
				commandLine 'pkill', '-f', 'gradle.*bootRun'
			}
		}
	}
}

// Tareas especÃ­ficas para cada servicio con configuraciÃ³n optimizada
['config-server', 'eureka-server', 'api-gateway', 'hello-world-service', 'arca-cotizador', 'arca-gestor-solicitudes'].each { serviceName ->
	
	// Tarea para ejecutar servicio en modo desarrollo
	task "start${serviceName.split('-').collect { it.capitalize() }.join('')}Dev" {
		description = "Inicia ${serviceName} en modo desarrollo con live reload"
		group = 'Arka Development'
		
		doLast {
			println "ğŸš€ Iniciando ${serviceName} en modo desarrollo..."
			
			exec {
				commandLine './gradlew', ":${serviceName}:bootRun", "-Pdev", "-Pdebug"
			}
		}
	}
	
	// Tarea para ejecutar servicio standalone (sin Eureka)
	task "start${serviceName.split('-').collect { it.capitalize() }.join('')}Standalone" {
		description = "Inicia ${serviceName} en modo standalone (sin Eureka)"
		group = 'Arka Development'
		
		doLast {
			println "ğŸ”§ Iniciando ${serviceName} en modo standalone..."
			
			exec {
				commandLine './gradlew', ":${serviceName}:bootRun", 
					"--args=--eureka.client.enabled=false --spring.profiles.active=standalone"
			}
		}
	}
}

// Tarea para compilaciÃ³n continua
task continuousBuild {
	description = 'Inicia compilaciÃ³n continua para desarrollo'
	group = 'Arka Development'
	
	doLast {
		println "ğŸ”„ Iniciando compilaciÃ³n continua..."
		println "ğŸ’¡ Los cambios se recompilarÃ¡n automÃ¡ticamente"
		
		exec {
			commandLine './gradlew', 'classes', '--continuous'
		}
	}
}

// Tarea para generar reporte de dependencias
task dependencyReport {
	description = 'Genera reporte de dependencias de todos los mÃ³dulos'
	group = 'Arka Reports'
	
	doLast {
		println "ğŸ“Š Generando reporte de dependencias..."
		
		subprojects.each { subproject ->
			println "\nğŸ” Dependencias de ${subproject.name}:"
			subproject.configurations.compileClasspath.each { dep ->
				if (!dep.name.endsWith('.jar')) return
				println "   â””â”€ ${dep.name}"
			}
		}
	}
}

// ConfiguraciÃ³n especÃ­fica del mÃ³dulo principal
group = 'com.arka'
version = '0.0.1-SNAPSHOT'

java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(21)
	}
}

dependencyManagement {
	imports {
		mavenBom 'org.springframework.cloud:spring-cloud-dependencies:2023.0.1'
	}
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'org.springframework.boot:spring-boot-starter-webflux'
	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
	implementation 'software.amazon.awssdk:regions:2.33.0'
	implementation 'software.amazon.awssdk:s3:2.25.18'
	implementation 'software.amazon.awssdk:core:2.25.18'
	implementation 'software.amazon.awssdk:regions:2.25.18'
	// implementation 'org.springframework.boot:spring-boot-starter-data-r2dbc' // Comentado temporalmente
	implementation 'org.springframework.cloud:spring-cloud-starter-config'
	implementation 'org.springframework.cloud:spring-cloud-starter-bootstrap'
	
	// ğŸƒ MongoDB dependencies
	implementation 'org.springframework.boot:spring-boot-starter-data-mongodb'
	implementation 'org.springframework.boot:spring-boot-starter-data-mongodb-reactive'
	
	// ğŸ“§ Email dependencies
	implementation 'org.springframework.boot:spring-boot-starter-mail'
	implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
	
	// Spring Security dependencies
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'org.springframework.security:spring-security-oauth2-resource-server'
	implementation 'org.springframework.security:spring-security-oauth2-jose'
	implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
	implementation 'io.jsonwebtoken:jjwt-impl:0.12.3'
	implementation 'io.jsonwebtoken:jjwt-jackson:0.12.3'
	implementation 'org.springframework.security:spring-security-crypto'
	
	// Database dependencies
	runtimeOnly 'com.mysql:mysql-connector-j'
	testImplementation 'com.h2database:h2'
	testRuntimeOnly 'com.h2database:h2'
	
	providedRuntime 'org.springframework.boot:spring-boot-starter-tomcat'

	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.springframework.security:spring-security-test'
	testImplementation 'io.projectreactor:reactor-test' // Para StepVerifier
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

tasks.named('test') {
	useJUnitPlatform()
	finalizedBy jacocoTestReport
}

// ğŸ“Š ConfiguraciÃ³n JaCoCo principal
jacoco {
	toolVersion = "0.8.11"
}

jacocoTestReport {
	dependsOn test
	reports {
		xml.required = true
		html.required = true
		csv.required = false
	}
	
	afterEvaluate {
		classDirectories.setFrom(files(classDirectories.files.collect {
			fileTree(dir: it, exclude: [
				'**/config/**',
				'**/dto/**',
				'**/*Application*',
				'**/Vulnerable*',
				'**/CodeSmells*'
			])
		}))
	}
}

jacocoTestCoverageVerification {
	violationRules {
		rule {
			limit {
				minimum = 0.60
			}
		}
	}
}

// ğŸ“Š Task para reporte agregado de cobertura
task jacocoAggregatedReport(type: JacocoReport) {
	dependsOn subprojects.test
	
	description = 'Generates an aggregated code coverage report from all subprojects'
	group = 'verification'
	
	additionalSourceDirs.from files(subprojects.sourceSets.main.allSource.srcDirs)
	sourceDirectories.from files(subprojects.sourceSets.main.allSource.srcDirs)
	classDirectories.from files(subprojects.sourceSets.main.output)
	executionData.from files(subprojects.jacocoTestReport.executionData)
	
	reports {
		html.required = true
		xml.required = true
		csv.required = false
		html.outputLocation = layout.buildDirectory.dir('reports/jacoco/aggregate/html')
		xml.outputLocation = layout.buildDirectory.file('reports/jacoco/aggregate/jacocoTestReport.xml')
	}
	
	// Exclusiones para el reporte agregado
	afterEvaluate {
		classDirectories.setFrom(files(classDirectories.files.collect {
			fileTree(dir: it, exclude: [
				'**/config/**',
				'**/dto/**',
				'**/*Application*',
				'**/Vulnerable*',
				'**/CodeSmells*',
				'**/test/**'
			])
		}))
	}
}

// ğŸ” ConfiguraciÃ³n SonarQube
sonarqube {
	properties {
		property "sonar.projectKey", "arkavalenzuela"
		property "sonar.projectName", "Arka Valenzuela"
		property "sonar.projectVersion", version
		property "sonar.sourceEncoding", "UTF-8"
		property "sonar.sources", "src/main/java"
		property "sonar.tests", "src/test/java"
		property "sonar.java.coveragePlugin", "jacoco"
		property "sonar.coverage.jacoco.xmlReportPaths", "build/reports/jacoco/aggregate/jacocoTestReport.xml"
		property "sonar.junit.reportPaths", "build/test-results/test"
		property "sonar.exclusions", "**/Vulnerable*.java,**/CodeSmells*.java,**/config/**,**/dto/**,**/*Application*.java"
		property "sonar.coverage.exclusions", "**/Vulnerable*.java,**/CodeSmells*.java,**/config/**,**/dto/**,**/*Application*.java"
	}
}

// ğŸš€ PIPELINE PRINCIPAL - TASK RUNMAIN CON MÃšLTIPLES STAGES
task runMain {
	group = 'application'
	description = 'Ejecuta el pipeline completo de build con mÃºltiples stages'
	
	doLast {
		println """
		ğŸš€ ====================================================
		    INICIANDO PIPELINE PRINCIPAL ARKA VALENZUELA
		ğŸš€ ====================================================
		"""
	}
}

// ğŸ§¹ STAGE 1: Limpieza
task stageClean {
	group = 'pipeline'
	description = 'Stage 1: Limpia todos los artefactos de build anteriores'
	dependsOn clean
	
	doFirst {
		println """
		ğŸ§¹ ==================== STAGE 1 ====================
		    LIMPIEZA DE ARTEFACTOS
		ğŸ§¹ ===================================================
		"""
	}
	
	doLast {
		println "âœ… Stage 1 Completado: Limpieza exitosa"
	}
}

// ğŸ”§ STAGE 2: CompilaciÃ³n
task stageCompile {
	group = 'pipeline'
	description = 'Stage 2: Compila el cÃ³digo fuente de todos los mÃ³dulos'
	dependsOn stageClean, compileJava
	mustRunAfter stageClean
	
	doFirst {
		println """
		ğŸ”§ ==================== STAGE 2 ====================
		    COMPILACIÃ“N DEL CÃ“DIGO FUENTE
		ğŸ”§ ===================================================
		"""
	}
	
	doLast {
		println "âœ… Stage 2 Completado: CompilaciÃ³n exitosa"
	}
}

// ğŸ§ª STAGE 3: Testing
task stageTesting {
	group = 'pipeline'
	description = 'Stage 3: Ejecuta todos los tests unitarios e integraciÃ³n'
	dependsOn stageCompile, test
	mustRunAfter stageCompile
	
	doFirst {
		println """
		ğŸ§ª ==================== STAGE 3 ====================
		    EJECUCIÃ“N DE TESTS
		ğŸ§ª ===================================================
		"""
	}
	
	doLast {
		println "âœ… Stage 3 Completado: Tests ejecutados correctamente"
	}
}

// ğŸ“Š STAGE 4: AnÃ¡lisis de Cobertura
task stageCoverage {
	group = 'pipeline'
	description = 'Stage 4: Genera reportes de cobertura con JaCoCo'
	dependsOn stageTesting, jacocoTestReport, jacocoAggregatedReport
	mustRunAfter stageTesting
	
	doFirst {
		println """
		ğŸ“Š ==================== STAGE 4 ====================
		    ANÃLISIS DE COBERTURA DE CÃ“DIGO
		ğŸ“Š ===================================================
		"""
	}
	
	doLast {
		println "âœ… Stage 4 Completado: Reportes de cobertura generados"
		println "ğŸ“„ Reporte HTML: build/reports/jacoco/aggregate/html/index.html"
	}
}

// ğŸ” STAGE 5: AnÃ¡lisis de Calidad
task stageQuality {
	group = 'pipeline'
	description = 'Stage 5: Ejecuta anÃ¡lisis de calidad de cÃ³digo'
	dependsOn stageCoverage, jacocoTestCoverageVerification
	mustRunAfter stageCoverage
	
	doFirst {
		println """
		ğŸ” ==================== STAGE 5 ====================
		    ANÃLISIS DE CALIDAD DE CÃ“DIGO
		ğŸ” ===================================================
		"""
	}
	
	doLast {
		println "âœ… Stage 5 Completado: VerificaciÃ³n de calidad exitosa"
	}
}

// ğŸ“¦ STAGE 6: Empaquetado
task stagePackage {
	group = 'pipeline'
	description = 'Stage 6: Genera artefactos ejecutables (JAR/WAR)'
	dependsOn stageQuality, build, bootJar
	mustRunAfter stageQuality
	
	doFirst {
		println """
		ğŸ“¦ ==================== STAGE 6 ====================
		    EMPAQUETADO DE ARTEFACTOS
		ğŸ“¦ ===================================================
		"""
	}
	
	doLast {
		println "âœ… Stage 6 Completado: Artefactos generados correctamente"
		println "ğŸ“„ JAR Principal: build/libs/${project.name}-${version}.jar"
	}
}

// ğŸ³ STAGE 7: PreparaciÃ³n Docker
task stageDocker {
	group = 'pipeline'
	description = 'Stage 7: Prepara imÃ¡genes Docker (opcional)'
	dependsOn stagePackage
	mustRunAfter stagePackage
	
	doFirst {
		println """
		ğŸ³ ==================== STAGE 7 ====================
		    PREPARACIÃ“N DE CONTENEDORES DOCKER
		ğŸ³ ===================================================
		"""
	}
	
	doLast {
		println "âœ… Stage 7 Completado: PreparaciÃ³n Docker lista"
		println "ğŸ’¡ Ejecuta: docker-compose build para crear imÃ¡genes"
	}
}

// ğŸ“‹ STAGE 8: Reporte Final
task stageFinalReport {
	group = 'pipeline'
	description = 'Stage 8: Genera reporte final del pipeline'
	dependsOn stageDocker
	mustRunAfter stageDocker
	
	doFirst {
		println """
		ğŸ“‹ ==================== STAGE 8 ====================
		    REPORTE FINAL DEL PIPELINE
		ğŸ“‹ ===================================================
		"""
	}
	
	doLast {
		println """
		ğŸ‰ ====================================================
		    PIPELINE COMPLETADO EXITOSAMENTE
		ğŸ‰ ====================================================
		
		ğŸ“Š RESUMEN DE ARTEFACTOS GENERADOS:
		   â€¢ JAR Principal: build/libs/${project.name}-${version}.jar
		   â€¢ Reportes de Tests: build/reports/tests/test/index.html
		   â€¢ Cobertura HTML: build/reports/jacoco/aggregate/html/index.html
		   â€¢ Cobertura XML: build/reports/jacoco/aggregate/jacocoTestReport.xml
		
		ğŸš€ PRÃ“XIMOS PASOS:
		   â€¢ Revisar reportes de cobertura
		   â€¢ Ejecutar SonarQube: ./gradlew sonarqube
		   â€¢ Desplegar con Docker: docker-compose up
		
		âœ… BUILD EXITOSO - TODOS LOS STAGES COMPLETADOS
		"""
	}
}

// ğŸ”— Configurar dependencias del runMain
runMain.dependsOn stageFinalReport

// ğŸ¯ TASKS AUXILIARES PARA DESARROLLADORES

// ğŸ§ª Task para solo testing
task runTests {
	group = 'application'
	description = 'Ejecuta solo los stages de testing y cobertura'
	dependsOn stageCoverage
	
	doLast {
		println "ğŸ§ª Testing pipeline completado"
	}
}

// ğŸ” Task para anÃ¡lisis de calidad completo
task runQuality {
	group = 'application'
	description = 'Ejecuta anÃ¡lisis completo de calidad con SonarQube'
	dependsOn stageQuality, sonarqube
	
	doLast {
		println "ğŸ” AnÃ¡lisis de calidad completo enviado a SonarQube"
	}
}

// âš¡ Task para build rÃ¡pido (sin tests)
task runFast {
	group = 'application'
	description = 'Build rÃ¡pido sin tests para desarrollo'
	dependsOn stageCompile, build
	
	doLast {
		println "âš¡ Build rÃ¡pido completado (sin tests)"
	}
}

// ğŸ“Š Task para solo reportes
task runReports {
	group = 'application'
	description = 'Genera solo reportes de cobertura y calidad'
	dependsOn test, jacocoTestReport, jacocoAggregatedReport
	
	doLast {
		println """
		ğŸ“Š Reportes generados:
		   â€¢ HTML: build/reports/jacoco/aggregate/html/index.html
		   â€¢ XML: build/reports/jacoco/aggregate/jacocoTestReport.xml
		"""
	}
}
