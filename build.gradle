plugins {
	id 'java'
	id 'war'
	id 'org.springframework.boot' version '3.2.3'
	id 'io.spring.dependency-management' version '1.1.4'
	id 'jacoco'
	id 'org.sonarqube' version '4.4.1.3373'
}

// ConfiguraciÃ³n comÃºn para todos los mÃ³dulos
allprojects {
	group = 'com.arka'
	version = '0.0.1-SNAPSHOT'
	
	repositories {
		mavenCentral()
	}
}

// ConfiguraciÃ³n para submÃ³dulos
subprojects {
	apply plugin: 'java'
	apply plugin: 'org.springframework.boot'
	apply plugin: 'io.spring.dependency-management'
	apply plugin: 'jacoco'
	
	java {
		toolchain {
			languageVersion = JavaLanguageVersion.of(21)
		}
	}
	
	dependencyManagement {
		imports {
			mavenBom 'org.springframework.cloud:spring-cloud-dependencies:2023.0.1'
		}
	}
	
	dependencies {
		implementation 'org.springframework.boot:spring-boot-starter'
		implementation 'org.springframework.boot:spring-boot-starter-webflux'
		implementation 'org.springframework.cloud:spring-cloud-starter-config'
		implementation 'org.springframework.cloud:spring-cloud-starter-bootstrap'
		
		// Spring Security dependencies para todos los mÃ³dulos
		implementation 'org.springframework.boot:spring-boot-starter-security'
		implementation 'org.springframework.security:spring-security-oauth2-resource-server'
		implementation 'org.springframework.security:spring-security-oauth2-jose'
		implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
		implementation 'io.jsonwebtoken:jjwt-impl:0.12.3'
		implementation 'io.jsonwebtoken:jjwt-jackson:0.12.3'
		implementation 'org.springframework.security:spring-security-crypto'
		implementation 'software.amazon.awssdk:regions:2.33.0'

		implementation 'software.amazon.awssdk:s3:2.25.18'
		implementation 'software.amazon.awssdk:core:2.25.18'
		implementation 'software.amazon.awssdk:regions:2.25.18'
		implementation 'org.springframework.boot:spring-boot-starter-web'
		annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
				
		testImplementation 'org.springframework.boot:spring-boot-starter-test'
		testImplementation 'org.springframework.security:spring-security-test'
		testImplementation 'io.projectreactor:reactor-test'
		testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
	}
	
	tasks.named('test') {
		useJUnitPlatform()
		finalizedBy jacocoTestReport
	}
	
	// ğŸ“Š ConfiguraciÃ³n JaCoCo para submÃ³dulos
	jacoco {
		toolVersion = "0.8.11"
	}
	
	jacocoTestReport {
		dependsOn test
		reports {
			xml.required = true
			html.required = true
			csv.required = false
		}
		
		// Exclusiones especÃ­ficas para cada submÃ³dulo
		afterEvaluate {
			classDirectories.setFrom(files(classDirectories.files.collect {
				fileTree(dir: it, exclude: [
					'**/config/**',
					'**/dto/**',
					'**/*Application*',
					'**/Vulnerable*',
					'**/CodeSmells*'
				])
			}))
		}
	}
	
	jacocoTestCoverageVerification {
		violationRules {
			rule {
				limit {
					minimum = 0.60 // 60% mÃ­nimo de cobertura
				}
			}
		}
	}
}

// ConfiguraciÃ³n especÃ­fica del mÃ³dulo principal
group = 'com.arka'
version = '0.0.1-SNAPSHOT'

java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(21)
	}
}

dependencyManagement {
	imports {
		mavenBom 'org.springframework.cloud:spring-cloud-dependencies:2023.0.1'
	}
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'org.springframework.boot:spring-boot-starter-webflux'
	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
	implementation 'software.amazon.awssdk:regions:2.33.0'
	implementation 'software.amazon.awssdk:s3:2.25.18'
	implementation 'software.amazon.awssdk:core:2.25.18'
	implementation 'software.amazon.awssdk:regions:2.25.18'
	// implementation 'org.springframework.boot:spring-boot-starter-data-r2dbc' // Comentado temporalmente
	implementation 'org.springframework.cloud:spring-cloud-starter-config'
	implementation 'org.springframework.cloud:spring-cloud-starter-bootstrap'
	
	// ğŸƒ MongoDB dependencies
	implementation 'org.springframework.boot:spring-boot-starter-data-mongodb'
	implementation 'org.springframework.boot:spring-boot-starter-data-mongodb-reactive'
	
	// ğŸ“§ Email dependencies
	implementation 'org.springframework.boot:spring-boot-starter-mail'
	implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
	
	// Spring Security dependencies
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'org.springframework.security:spring-security-oauth2-resource-server'
	implementation 'org.springframework.security:spring-security-oauth2-jose'
	implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
	implementation 'io.jsonwebtoken:jjwt-impl:0.12.3'
	implementation 'io.jsonwebtoken:jjwt-jackson:0.12.3'
	implementation 'org.springframework.security:spring-security-crypto'
	
	// Database dependencies
	runtimeOnly 'com.mysql:mysql-connector-j'
	testImplementation 'com.h2database:h2'
	testRuntimeOnly 'com.h2database:h2'
	
	providedRuntime 'org.springframework.boot:spring-boot-starter-tomcat'

	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.springframework.security:spring-security-test'
	testImplementation 'io.projectreactor:reactor-test' // Para StepVerifier
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

tasks.named('test') {
	useJUnitPlatform()
	finalizedBy jacocoTestReport
}

// ğŸ“Š ConfiguraciÃ³n JaCoCo principal
jacoco {
	toolVersion = "0.8.11"
}

jacocoTestReport {
	dependsOn test
	reports {
		xml.required = true
		html.required = true
		csv.required = false
	}
	
	afterEvaluate {
		classDirectories.setFrom(files(classDirectories.files.collect {
			fileTree(dir: it, exclude: [
				'**/config/**',
				'**/dto/**',
				'**/*Application*',
				'**/Vulnerable*',
				'**/CodeSmells*'
			])
		}))
	}
}

jacocoTestCoverageVerification {
	violationRules {
		rule {
			limit {
				minimum = 0.60
			}
		}
	}
}

// ğŸ“Š Task para reporte agregado de cobertura
task jacocoAggregatedReport(type: JacocoReport) {
	dependsOn subprojects.test
	
	description = 'Generates an aggregated code coverage report from all subprojects'
	group = 'verification'
	
	additionalSourceDirs.from files(subprojects.sourceSets.main.allSource.srcDirs)
	sourceDirectories.from files(subprojects.sourceSets.main.allSource.srcDirs)
	classDirectories.from files(subprojects.sourceSets.main.output)
	executionData.from files(subprojects.jacocoTestReport.executionData)
	
	reports {
		html.required = true
		xml.required = true
		csv.required = false
		html.outputLocation = layout.buildDirectory.dir('reports/jacoco/aggregate/html')
		xml.outputLocation = layout.buildDirectory.file('reports/jacoco/aggregate/jacocoTestReport.xml')
	}
	
	// Exclusiones para el reporte agregado
	afterEvaluate {
		classDirectories.setFrom(files(classDirectories.files.collect {
			fileTree(dir: it, exclude: [
				'**/config/**',
				'**/dto/**',
				'**/*Application*',
				'**/Vulnerable*',
				'**/CodeSmells*',
				'**/test/**'
			])
		}))
	}
}

// ğŸ” ConfiguraciÃ³n SonarQube
sonarqube {
	properties {
		property "sonar.projectKey", "arkavalenzuela"
		property "sonar.projectName", "Arka Valenzuela"
		property "sonar.projectVersion", version
		property "sonar.sourceEncoding", "UTF-8"
		property "sonar.sources", "src/main/java"
		property "sonar.tests", "src/test/java"
		property "sonar.java.coveragePlugin", "jacoco"
		property "sonar.coverage.jacoco.xmlReportPaths", "build/reports/jacoco/aggregate/jacocoTestReport.xml"
		property "sonar.junit.reportPaths", "build/test-results/test"
		property "sonar.exclusions", "**/Vulnerable*.java,**/CodeSmells*.java,**/config/**,**/dto/**,**/*Application*.java"
		property "sonar.coverage.exclusions", "**/Vulnerable*.java,**/CodeSmells*.java,**/config/**,**/dto/**,**/*Application*.java"
	}
}

// ğŸš€ =====================================================================
// ğŸ—ï¸ PIPELINE DE BUILD CON MÃšLTIPLES STAGES
// ğŸš€ =====================================================================

// ğŸ§¹ STAGE 1: CLEANING
task cleanStage {
	group = 'build-pipeline'
	description = 'ğŸ§¹ Stage 1: Clean all build artifacts and cache'
	
	doFirst {
		println "\nğŸš€ ============================================="
		println "ğŸ§¹ STAGE 1: CLEANING"
		println "ğŸš€ ============================================="
		println "ğŸ“‚ Cleaning build directories..."
		println "ğŸ—‘ï¸  Removing cache files..."
	}
	
	dependsOn clean
	subprojects.each { project ->
		dependsOn "${project.path}:clean"
	}
	
	doLast {
		println "âœ… Stage 1 completed: All artifacts cleaned"
	}
}

// ğŸ” STAGE 2: CODE QUALITY ANALYSIS
task codeQualityStage {
	group = 'build-pipeline'
	description = 'ğŸ” Stage 2: Static code analysis and quality checks'
	dependsOn cleanStage
	
	doFirst {
		println "\nğŸš€ ============================================="
		println "ğŸ” STAGE 2: CODE QUALITY ANALYSIS"
		println "ğŸš€ ============================================="
		println "ğŸ” Running static code analysis..."
		println "ğŸ“Š Checking code style and quality..."
	}
	
	// Agregar dependencias para anÃ¡lisis estÃ¡tico cuando estÃ©n disponibles
	// dependsOn checkstyleMain, pmd, spotbugs
	
	doLast {
		println "âœ… Stage 2 completed: Code quality verified"
	}
}

// ğŸ§ª STAGE 3: TESTING
task testingStage {
	group = 'build-pipeline'
	description = 'ğŸ§ª Stage 3: Run all tests with coverage analysis'
	dependsOn codeQualityStage
	
	doFirst {
		println "\nğŸš€ ============================================="
		println "ğŸ§ª STAGE 3: TESTING"
		println "ğŸš€ ============================================="
		println "ğŸ§ª Running unit tests..."
		println "ğŸ”— Running integration tests..."
		println "ğŸ“Š Generating coverage reports..."
	}
	
	// Tests del proyecto principal
	dependsOn test
	
	// Tests de todos los submÃ³dulos
	subprojects.each { project ->
		dependsOn "${project.path}:test"
	}
	
	// Reportes de cobertura
	finalizedBy jacocoTestReport, jacocoAggregatedReport
	
	doLast {
		println "âœ… Stage 3 completed: All tests passed with coverage"
		println "ğŸ“Š Coverage reports generated in build/reports/jacoco/"
	}
}

// ğŸ”§ STAGE 4: COMPILATION
task compilationStage {
	group = 'build-pipeline'
	description = 'ğŸ”§ Stage 4: Compile all source code'
	dependsOn testingStage
	
	doFirst {
		println "\nğŸš€ ============================================="
		println "ğŸ”§ STAGE 4: COMPILATION"
		println "ğŸš€ ============================================="
		println "âš™ï¸  Compiling main classes..."
		println "ğŸ§ª Compiling test classes..."
	}
	
	// CompilaciÃ³n del proyecto principal
	dependsOn compileJava, compileTestJava
	
	// CompilaciÃ³n de todos los submÃ³dulos
	subprojects.each { project ->
		dependsOn "${project.path}:compileJava"
		dependsOn "${project.path}:compileTestJava"
	}
	
	doLast {
		println "âœ… Stage 4 completed: All code compiled successfully"
	}
}

// ğŸ“¦ STAGE 5: PACKAGING
task packagingStage {
	group = 'build-pipeline'
	description = 'ğŸ“¦ Stage 5: Create JAR files and packages'
	dependsOn compilationStage
	
	doFirst {
		println "\nğŸš€ ============================================="
		println "ğŸ“¦ STAGE 5: PACKAGING"
		println "ğŸš€ ============================================="
		println "ğŸ“¦ Creating JAR files..."
		println "ğŸ³ Preparing Docker artifacts..."
	}
	
	// Packaging del proyecto principal
	dependsOn jar, bootJar
	
	// Packaging de todos los submÃ³dulos
	subprojects.each { project ->
		dependsOn "${project.path}:bootJar"
	}
	
	doLast {
		println "âœ… Stage 5 completed: All packages created"
		println "ğŸ“¦ JAR files available in build/libs/"
	}
}

// ğŸ” STAGE 6: QUALITY VERIFICATION
task qualityVerificationStage {
	group = 'build-pipeline'
	description = 'ğŸ” Stage 6: Verify quality gates and coverage thresholds'
	dependsOn packagingStage
	
	doFirst {
		println "\nğŸš€ ============================================="
		println "ğŸ” STAGE 6: QUALITY VERIFICATION"
		println "ğŸš€ ============================================="
		println "ğŸ“Š Verifying coverage thresholds..."
		println "ğŸ¯ Checking quality gates..."
	}
	
	dependsOn jacocoTestCoverageVerification
	
	doLast {
		println "âœ… Stage 6 completed: Quality gates passed"
		println "ğŸ“Š Coverage threshold (60%) met"
	}
}

// ğŸš€ STAGE 7: DEPLOYMENT PREPARATION
task deploymentPrepStage {
	group = 'build-pipeline'
	description = 'ğŸš€ Stage 7: Prepare artifacts for deployment'
	dependsOn qualityVerificationStage
	
	doFirst {
		println "\nğŸš€ ============================================="
		println "ğŸš€ STAGE 7: DEPLOYMENT PREPARATION"
		println "ğŸš€ ============================================="
		println "ğŸ³ Validating Docker configurations..."
		println "â˜ï¸  Preparing cloud deployment artifacts..."
	}
	
	doLast {
		println "âœ… Stage 7 completed: Ready for deployment"
		println "ğŸ³ Docker files validated"
		println "â˜ï¸  Cloud artifacts prepared"
	}
}

// ğŸ“Š STAGE 8: SONARQUBE ANALYSIS (OPTIONAL)
task sonarAnalysisStage {
	group = 'build-pipeline'
	description = 'ğŸ“Š Stage 8: SonarQube analysis (optional)'
	dependsOn deploymentPrepStage
	
	doFirst {
		println "\nğŸš€ ============================================="
		println "ğŸ“Š STAGE 8: SONARQUBE ANALYSIS"
		println "ğŸš€ ============================================="
		println "ğŸ” Sending metrics to SonarQube..."
		println "ğŸ“ˆ Analyzing technical debt..."
	}
	
	// Solo ejecutar si SonarQube estÃ¡ disponible
	doLast {
		if (project.hasProperty('runSonar') && project.runSonar == 'true') {
			dependsOn sonarqube
			println "âœ… Stage 8 completed: SonarQube analysis finished"
		} else {
			println "â­ï¸  Stage 8 skipped: Use -PrunSonar=true to enable"
		}
	}
}

// ğŸ¯ =====================================================================
// ğŸš€ MAIN BUILD PIPELINE TASK
// ğŸ¯ =====================================================================

task runMain {
	group = 'build-pipeline'
	description = 'ğŸš€ MAIN PIPELINE: Execute complete build with all stages'
	
	dependsOn sonarAnalysisStage
	
	doFirst {
		println """
ğŸš€ ============================================= ğŸš€
ğŸ—ï¸           ARKA VALENZUELA BUILD PIPELINE
ğŸš€ ============================================= ğŸš€

ğŸ“‹ Pipeline Stages:
   1. ğŸ§¹ Cleaning
   2. ğŸ” Code Quality Analysis  
   3. ğŸ§ª Testing & Coverage
   4. ğŸ”§ Compilation
   5. ğŸ“¦ Packaging
   6. ğŸ” Quality Verification
   7. ğŸš€ Deployment Preparation
   8. ğŸ“Š SonarQube Analysis (optional)

ğŸ¯ Starting complete build pipeline...
"""
	}
	
	doLast {
		println """
ğŸ‰ ============================================= ğŸ‰
ğŸ†           BUILD PIPELINE COMPLETED
ğŸ‰ ============================================= ğŸ‰

âœ… All stages completed successfully!

ğŸ“Š Build Summary:
   ğŸ§¹ Cleaned: All artifacts removed
   ğŸ” Quality: Code analysis passed
   ğŸ§ª Tests: All tests passed with coverage
   ğŸ”§ Compiled: All modules compiled
   ğŸ“¦ Packaged: JAR files created
   ğŸ” Verified: Quality gates met
   ğŸš€ Ready: Deployment artifacts prepared

ğŸ“‚ Generated Artifacts:
   ğŸ“¦ JAR files: build/libs/
   ğŸ“Š Test reports: build/reports/tests/
   ğŸ“ˆ Coverage: build/reports/jacoco/
   ğŸ“‹ Build logs: Available in console

ğŸš€ Next Steps:
   ğŸ³ Docker: ./gradlew dockerBuild
   â˜ï¸  Deploy: ./gradlew deploy
   ğŸ“Š SonarQube: ./gradlew runMain -PrunSonar=true

ğŸ¯ Build completed successfully!
"""
	}
}

// ğŸ¯ =====================================================================
// ğŸ› ï¸ UTILITY TASKS
// ğŸ¯ =====================================================================

// ğŸš€ Quick build without SonarQube
task quickBuild {
	group = 'build-pipeline'
	description = 'âš¡ Quick build: Essential stages only'
	dependsOn deploymentPrepStage
	
	doLast {
		println "âš¡ Quick build completed! Skipped SonarQube analysis."
	}
}

// ğŸ§ª Test-only pipeline
task testOnly {
	group = 'build-pipeline'
	description = 'ğŸ§ª Run tests and coverage only'
	dependsOn testingStage
	
	doLast {
		println "ğŸ§ª Test pipeline completed!"
	}
}

// ğŸ“¦ Build without tests (for rapid iteration)
task buildNoTest {
	group = 'build-pipeline'
	description = 'ğŸ“¦ Build without running tests'
	dependsOn packagingStage
	
	doFirst {
		println "âš ï¸  Building without tests - use only for rapid development!"
	}
	
	tasks.test.enabled = false
	subprojects.each { project ->
		project.tasks.test.enabled = false
	}
}

// ğŸ” Quality check only
task qualityCheck {
	group = 'build-pipeline'
	description = 'ğŸ” Run quality analysis without build'
	dependsOn qualityVerificationStage
	
	doLast {
		println "ğŸ” Quality check completed!"
	}
}

// ğŸ“Š Coverage report only
task coverageReport {
	group = 'build-pipeline'
	description = 'ğŸ“Š Generate coverage reports only'
	dependsOn jacocoAggregatedReport
	
	doLast {
		println "ğŸ“Š Coverage reports generated in build/reports/jacoco/"
	}
}
